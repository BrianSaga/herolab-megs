<?xml version="1.0" encoding="ISO-8859-1"?>

<!-- This file contains the definition of a traditional "statblock" output for the
      game system. The statblock is defined as a dossier and then uses an assortment
      of procedures to orchestrate the synthesis of the output.
-->

<document signature="Hero Lab Data">


  <!-- Procedure sbname
        Get the character's name, using a suitable default if unnamed. The name is
        placed in the "name" text variable.

        Outbound parameter: name
  -->
  <procedure id="sbname" scripttype="synthesize"><![CDATA[
    var name as string
    if (empty(hero.actorname) = 0) then
      name = hero.actorname
    else
      name = "Unnamed Character"
      endif
    ]]></procedure>


  <!-- Procedure sbtraits
        Output all of the traits that satisfy the provided tag expression, reporting
        the name and final value for each. The "tagexpr" text variable specifies the
        constraints that must be satisfied for the list of traits.

        Inbound parameter:  tagexpr
  -->
  <procedure id="sbtraits" scripttype="synthesize"><![CDATA[
      var dex as number
	  var str as number
	  var bod as number
	  var inte as number
	  var wil as number
	  var min as number
	  var inf as number
	  var aur as number
	  var spi as number
	  
	  var gap as string
	  var txt as string
	  
	  gap = "     "
	  
	  dex = child[attrDex].field[trtFinal].value
	  str = child[attrStr].field[trtFinal].value
	  bod = child[attrBod].field[trtFinal].value
	  
	  inte = child[attrInt].field[trtFinal].value
	  wil = child[attrWil].field[trtFinal].value
	  min = child[attrMin].field[trtFinal].value

	  inf = child[attrInf].field[trtFinal].value
	  aur = child[attrAur].field[trtFinal].value
	  spi = child[attrSpi].field[trtFinal].value
	  
	  append @boldon & "Dex: " & @boldoff
	  if (dex < 10) then
		 append "0" & child[attrDex].field[trtFinal].text
	  else
		append child[attrDex].field[trtFinal].text
	  endif
	  append gap
	  
	  append @boldon & "Str: " & @boldoff
	  if (str < 10) then
		 append "0" & child[attrStr].field[trtFinal].text
	  else
		append child[attrStr].field[trtFinal].text
	  endif
	  append gap

	  append @boldon & "Bod:  " & @boldoff
	  if (bod < 10) then
		 append "0" & child[attrBod].field[trtFinal].text
	  else
		append child[attrBod].field[trtFinal].text
	  endif	
	  
      ~output motivation
      txt = hero.findchild[Motivation].field[name].text
      if (empty(txt) <> 0) then
		txt = "-none-"
      endif
      append @boldon & gap & "Motivation: " & @boldoff & txt & @newline  

	  append @boldon & "Int:   " & @boldoff
	  if (inte < 10) then
		 append "0" & child[attrInt].field[trtFinal].text
	  else
		append child[attrInt].field[trtFinal].text
	  endif
	  append gap
	  
	  append @boldon & "Wil: " & @boldoff
	  if (wil < 10) then
		 append "0" & child[attrWil].field[trtFinal].text
	  else
		append child[attrWil].field[trtFinal].text
	  endif
	  append gap

	  append @boldon & "Min:  " & @boldoff
	  if (min < 10) then
		 append "0" & child[attrMin].field[trtFinal].text
	  else
		append child[attrMin].field[trtFinal].text
	  endif	

      ~output occupation
      txt = hero.child[mscPerson].field[perOccup].text
      if (empty(txt) <> 0) then
		txt = "-none-"
      endif
      append @boldon & gap & "Occupation: " & @boldoff & txt & @newline

	  append @boldon & "Inf:   " & @boldoff
	  if (inf < 10) then
		 append "0" & child[attrInf].field[trtFinal].text
	  else
		append child[attrInf].field[trtFinal].text
	  endif
	  append gap
	  
	  append @boldon & "Aur: " & @boldoff
	  if (aur < 10) then
		 append "0" & child[attrAur].field[trtFinal].text
	  else
		append child[attrAur].field[trtFinal].text
	  endif
	  append gap

	  append @boldon & "Spi:  " & @boldoff
	  if (spi < 10) then
		 append "0" & child[attrSpi].field[trtFinal].text
	  else
		append child[attrSpi].field[trtFinal].text
	  endif	

      ~output wealth
      txt = hero.child[attrWealth].field[trtFinal].text
      if (empty(txt) <> 0) then
		txt = "-none-"
	  elseif (hero.child[attrWealth].field[trtFinal].value < 10) then
		txt = "00" & txt
	  elseif (hero.child[attrWealth].field[trtFinal].value < 100) then
		txt = "0" & txt
      endif
      append @boldon & gap &  "Wealth: " & @boldoff & txt & @newline

	  append @boldon & "Init:  " & @boldoff
	  if (hero.child[trInit].field[trtFinal].value < 10) then
		 append "00" & hero.child[trInit].field[trtFinal].text
	  elseif (hero.child[trInit].field[trtFinal].value < 100) then
		 append "0" & hero.child[trInit].field[trtFinal].text
	  else
		append hero.child[trInit].field[trtFinal].text
	  endif	
	  append gap 
	 
	  append @boldon & "HP:  " & @boldoff
	  if (hero.child[resHP].field[resLeft].value < 10) then
		 append "00" & hero.child[resHP].field[resLeft].text
	  elseif (hero.child[resHP].field[resLeft].value < 100) then
		append "0" & hero.child[resHP].field[resLeft].text
	  else
		append hero.child[resHP].field[resLeft].text
	  endif	
	  append @newline
    ]]></procedure>


  <!-- Procedure sbweapons
        Output all of the weapons possessed by the character, listing equipped
        weapons first and including attack values, damage, and ranges for eachpick.
  -->
  <procedure id="sbweapons" scripttype="synthesize"><![CDATA[
    var ismore as number
    append @boldon & "Weapons/Attacks: " & @boldoff & @newline
    ~output a list of all weapons (equipped first)
    ismore = 0
    foreach pick in hero from WeaponBase sortas Armory
      ismore = 1
      append @indent & eachpick.field[wpNetAtk].text & " - " & eachpick.field[name].text
      append " - " & eachpick.field[wpDamage].text
      if (eachpick.field[grIsEquip].value <> 0) then
        append " (Equipped)"
        endif
      if (eachpick.tagis[component.WeapRange] <> 0) then
        append " (Rng: " & eachpick.field[wpShort].text & "/" & eachpick.field[wpMedium].text & "/" & eachpick.field[wpLong].text & ")"
        endif
      append @newline
      nexteach
    ~if we have no weapons, output that fact
    if (ismore = 0) then
      append @indent & "-none-" & @newline
      endif
    ]]></procedure>


  <!-- Procedure sbarmor
        Output all of the armor possessed by the character, listing equipped gear
        first and including the defense value for eachpick.
  -->
  <procedure id="sbarmor" scripttype="synthesize"><![CDATA[
    var ismore as number
    append @boldon & "Armor: " & @boldoff & @newline
    ~output the details of all armor (equipped first)
    ismore = 0
    foreach pick in hero from Defense sortas Armory
      ismore = 1
      append @indent & eachpick.field[defDefense].text & " - " & eachpick.field[name].text
      if (eachpick.field[grIsEquip].value <> 0) then
        append " (Equipped)"
        endif
      append @newline
      nexteach
    ~if we have no armor, output that fact
    if (ismore = 0) then
      append @indent & "-none-" & @newline
      endif
    ]]></procedure>


  <!-- Procedure sbtrackres
        Output all of the tracked resources possessed by the character, if the
        right output source is enabled.
  -->
  <procedure id="sbtrackres" scripttype="synthesize"><![CDATA[
    doneif (hero.tagis[source.ShowTrackR] = 0)

    var ismore as number
    append @boldon & "Tracked Resources: " & @boldoff & @newline
    ~output the details of all resources
    ismore = 0
    foreach pick in hero from Tracker where "!Hide.Tracker"
      ismore = 1
      append @indent & eachpick.field[name].text & " - " & eachpick.field[trkUser].text
      append @newline
      nexteach
    ~if we have no resources, output that fact
    if (ismore = 0) then
      append @indent & "-none-" & @newline
      endif
    ]]></procedure>


  <!-- Procedure sbnpcinfo
        Checks all npc info picks with a certain tag expression and appends
        their info to the text.
  -->
  <procedure id="sbnpcinfo" scripttype="synthesize"><![CDATA[
    var title as string
    var tagexpr as string

    ~go through the npc info picks, adding them to the info string
    var info as string
    info = ""
    foreach pick in hero from NPCInfo where tagexpr sortas explicit
      if (eachpick.field[npcInfo].isempty = 0) then
        info &= eachpick.field[name].text & ": " & eachpick.field[npcInfo].text & @newline
        endif
      nexteach

    ~if we ended up with any text, append it to our output with the
    ~appropriate title
    if (empty(info) = 0) then
      append @newline & "===== " & title & " =====" & @newline
      append info
      endif
    ]]></procedure>


  <!-- Define the statblock as a text-based dossier. The "synthesize" script actually
        generates the output.
  -->
  <dossier
    id="statblock"
    name="Character Statblock">
    <dossier_text
      styles="plain+html+bbcode+wikitext+print"
      grouping="statblock">
      <synthesize><![CDATA[
        var txt as string
        var tagexpr as string

        ~start by getting our name
        var name as string
        call sbname

        ~output our name
        append @boldon & "Name: " & @boldoff & name & @newline 
		
		~our point total
		append "A " & hero.child[resHP].field[resSpent].value & " points Characer." & @newline & @newline

        ~output attributes
        call sbtraits

		~output tracked resources
        call sbtrackres

        ~output NPC details if this character is a NPC - if any field for any
        ~of the three blocks of text is set, output that block
        doneif (hero.tagis[CharType.typNPC] = 0)
        var tagexpr as string
        var title as string

        ~values of up to 15 are basic details only
        tagexpr = "val:explicit.? <= 15"
        title = "Basic Details"
        call sbnpcinfo

        ~values of up to 30 are tactics
        tagexpr = "val:explicit.? > 15 & val:explicit.? <= 30"
        title = "Tactics"
        call sbnpcinfo

        ~values of up to 45 are ecology
        tagexpr = "val:explicit.? > 30 & val:explicit.? <= 45"
        title = "Ecology"
        call sbnpcinfo

        ~anything else is extra
        tagexpr = "val:explicit.? > 45"
        title = "Additional Details"
        call sbnpcinfo
        ]]></synthesize>
      </dossier_text>
    </dossier>


  </document>
